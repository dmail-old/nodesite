<!--

Ce fichier est renvoyé à toute requête GET aux URLS suivantes:

- /*
- sauf si l'URL débute par un dossier existant: '/css/*, /js/*, /img/*'
- sauf si l'URL cible la racine, sur un fichier possédant extension autre que .js: '/manifest.appcache'

Il se charge d'afficher la page depuis le cache ou le serveur

-->

<!DOCTYPE html>

<html dir="ltr">

<head>

{metas}

<title>{title}</title>

{favicon}

<script>
var config = {config};
// Function.reviver existe pas encore ici
var lang = JSON.parse(JSON.stringify({lang}), function(key, value){
	return typeof value == 'string' && value.indexOf('(function (') === 0 ? eval(value) : value;
});

function loadUrl(filepath, callback){
	var type = filepath.match(/.js$/) ? 'js' : 'css';
	var element;

	if( type == 'js' ){
		element = document.createElement('script');
		element.type = 'text/javascript';
		element.charset = 'utf-8';
        element.async = false;
	}
	else if( type == 'css' ){
		element = document.createElement('link');
		element.type = 'text/css';
		element.rel = 'stylesheet';
	}

	/*
	if(typeof(scriptEl.addEventListener) != 'undefined') {
        // The FF, Chrome, Safari, Opera way

        scriptEl.addEventListener('load',calltheCBcmn,false);

      }

      else {
        // The MS IE 8+ way (may work with others - I dunno)

        function handleIeState() {

          if(scriptEl.readyState == 'loaded'){

            calltheCBcmn(scriptURL);

          }

        }

        var ret = scriptEl.attachEvent('onreadystatechange',handleIeState);

      }
	*/

	element.onload = function(){
		//console.log('Chargement du fichier ', type == 'js' ? this.src.replace(/^.*?js\//, '') : this.href.replace(/^.*?css\//, ''));
		if( typeof callback == 'function' ) callback();
	}
	document.head.appendChild(element);

	if( type == 'js' ) element.src = filepath;
	else element.href = filepath;
}

function createUrl(path){
	return config.protocol + '://' + config.host + (config.port ? ':' + config.port : '') + '/' + path;
}

function createFilePath(name, extension){
	return extension + '/' + name + '.' + extension;
}

function createUrlFromName(name, extension){
	return createUrl(createFilePath(name, extension));
}

function loadFiles(names, type, callback){
	var i = 0, j = names.length;

	for(;i<j;i++){
		loadUrl(createUrlFromName(names[i], type));
	}
}

function initAll(){

String.implement('stripScripts', function(exec){
	var scripts = '';
	var text = this.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi, function(all, code){
		scripts += code + '\n';
		return '';
	});

	if( exec === true ){
		Browser.exec(scripts);
	}
	else if( typeof exec == 'function' ){
		exec(scripts, text);
	}

	return text;
});

var typesHandler = {
	'application/json': function(){
		var text = this.response.text, json;

		try{
			json = JSON.parse(text);
		}
		catch(e){
			return this.emit('handle', e);
		}

		if( json == null ) return this.emit('handle', new Error('empty json'));
		if( json.error ) return this.emit('handle', new Error('SERVER : ' + json.message));
		this.emit('handle', null, json);
	},

	'text/html': function(){
		var html = this.response.text;
		this.emit('handle', null, html);
	}
};

var request = new Request({
	link: 'chain',
	method: 'post'
});

request.setHeader('Accept', 'application/json');
request.setHeader('X-Request', 'JSON');
request.options.isSuccess = function(){
	var status = this.status, ok = status >= 200 && status < 300;

	if( ok ){
		var type = this.getHeader('content-type');

		if( !typesHandler[type] ) this.emit('handle', new Error('response content type not supported'));
		else{
			typesHandler[type].call(this);
		}

		return true;
	}
	else{
		this.emit('handle', new Error('bad status'));

		return false;
	}
};
request.on('request', function(options){
	if( options && options.callback ) this.once('handle', options.callback);
});

var server = {
	request: request,

	init: function(callback){
		var data = {
			page: document.location.pathname
		};

		if( localStorage.userId ){
			data.userId = localStorage.userId;
		}

		this.callAction('init', data, callback);
	},

	applyAction: function(action, args, callback){
		request.send({
			callback: callback,
			data:{
				json: JSON.stringify([action].concat(args))
			}
		});
	},

	callAction: function(action){
		var args = toArray(arguments, 1);
		var callback = args[args.length-1];

		if( typeof callback == 'function' ) args.pop();

		return this.applyAction(action, args, callback);
	}
};

var Page = this.Page = {
	initialized: false,

	init: function(){
		document.on('click', Page.click, true);
		window.on('popstate', Page.popstate);

		this.go();
	},

	showProgress: function(){
		var progress = this.progress = document.createElement('progress');

		progress.max = 100;
		this.setProgress(0);
		document.body.appendChild(progress);
	},

	setProgress: function(percent){
		this.progress.value = percent;
		this.progress.innerHTML = precent + '%';
	},

	setPage: function(page){
		for(var key in page){
			if( setters[key] ) setters[key].call(this, page[key]);
		}
	},

	// demande au serveur la page se trouvant à url
	go: function(url, state){
		document.title = url;

		var filename = document.location.pathname, isHTML = filename.endsWith('.html');

		// prevent browser caching document
		// if( isHtml ) filename+= '?rand=' + new Date().getTime();

		server.callAction('go', filename, function(error, response){
			if( error ) return console.error(error);

			var type = this.getHeader('content-type');
			if( isHTML ){
				document.body.innerHTML = response;
				response.stripScripts(true); // évalue le javascript se trouvant dans le html
			}
			else{
				if( response.html ) document.body.innerHTML = response.html;
			}
		});
	},

	// bouton back ou next activé
	popstate: function(e){
		Page.go(document.location.href, e.state);
	},

	// lorsqu'on click sur un élément de la page
	click: function(e){
		var element = e.target;

		if( element != document && element.tagName.toLowerCase() == 'a' ){
			// click de molette
			if( e.code == 2 ) return true;
			// touche ctrl ou touche cmd
			if( e.control || e.meta ) return true;
			// URL courante, on laisse la page se recharger
			if( document.location.href == element.href ) return true;
			// URL externe
			if( document.location.hostname != element.hostname ) return true;

			// les URL internes entrainent une requête AJAX et history.pushState
			history.pushState(null, null, element.href);
			Page.go(element.href);
			e.preventDefault();
			return false;
		}
	}
};

Page.setters = {
	title: function(title){
		document.title = title;
	}
};

/*

on est en train de demander au serveur d'obtenir la page X

on a éventuellement une session sauvegardée en localStorage, dans ce cas faudrais envoyer ce jeton pour demander à restaurer cette session
ou pas puisqu'en fait les données sur l'utilisateur on les a ptet en cache

*/

Page.init();
window.server = server;

}

window.onerror = function(msg, url, line){
	//console.log('window error', arguments);
};

</script>

</head>

<body>

<script>
// avoid initial popstate event
window.onload = function(){
	setTimeout(initAll, 0);
};
loadFiles(config.css, 'css');
loadFiles(config.js, 'js');
</script>

</body>

</html>
