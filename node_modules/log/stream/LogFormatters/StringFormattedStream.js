var proto = require('@dmail/proto');
var TransformStream = require('stream').Transform;

var StringFormattedStream = proto.extend.call(TransformStream, {
	constructor: function(){
		StringFormattedStream.super.constructor.apply(this, arguments);
		this._writableState.objectMode = true;
		this._readableState.objectMode = false;
	},

	stringify: function(){
		throw new Error('unimplemented format');
	},

	_transform: function(chunk, encoding, done){
		// suppos√© recevoir que des objets
		var string;

		if( typeof chunk == 'string' ){
			string = chunk;
		}
		else if( Buffer.isBuffer(chunk) ){
			string = chunk.toString();
		}
		else if( typeof chunk == 'object' ){
			try{
				string = this.stringify(chunk);
			}
			catch(e){
				this.emit('error', e);
				return;
			}
		}

		this.push(string);
		done();
	}
});

module.exports = StringFormattedStream;