require('promise');
require('symbol');
require('iterator/ArrayIterator');

// exec a serie of promise allowing the promise to fail when filterReject returns true
// when it happens the next promise has a chance to fullfill, if not the promise is rejected
function first(iterable, bind, initialValue, filterReject, filterBind){
	if( !filterReject ){
		throw new TypeError('first expect a filterReject function');
	}

	var initialPromise = Promise.resolve(initialValue);

	return new Promise(function(resolve, reject){
		var iterator = iterable[Symbol.iterator](), next, fn, reason, rejected = false;

		function nextPromise(){
			next = iterator.next();

			if( next.done ){
				if( rejected ){
					reject(reason);
				}
				// can happen only if iterable is empty
				else{
					resolve();
				}
			}
			else{
				fn = next.value;
				if( typeof bind !== 'undefined' ) fn = fn.bind(bind);

				initialPromise.then(fn).then(
					resolve,
					function(value){
						if( filterReject.call(filterBind, value) ){
							rejected = true;
							reason = value;
							nextPromise();
						}
						else{
							reject(reason);
						}
					}
				);
			}
		}

		nextPromise();

	});
}

module.exports = first;
Promise.first = first;