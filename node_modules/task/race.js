// The `race` method accepts an array of tasks, or value coercable to tasks, and
// returns a task that will receive the value of the first task that
// either completes or fails.
// Afterward, all remaining tasks will be cancelled.

var proto = require('@dmail/proto');
var Task = require('./task');
var TaskList = require('task/task-list');

var RaceTask = proto.extend.call(TaskList, {
	onEmpty: function(){
		// nothing, task remains pending
	},

	onTaskCancellation: function(task){
		this.pendingCount--;
		if( this.pendingCount === 0 ){
			this.cancel(); // no task completed or failed
		}
	},

	onTaskCompletion: function(task){
		this.complete(task.value);
		this.cancelOtherTasks(task);
	},

	onTaskFailure: function(task){
		this.fail(task.value);
		this.cancelOtherTasks(task);
	}
});

function race(iterable){
	return RaceTask.create(iterable);
}

module.exports = race;
Task.race = race;