/*

*/

var TestPrototype = require('../TestPrototype');

var TestSerie = TestPrototype.create({
	name: 'Anonymous testSerie',
	Test: require('../Test'),
	type: 'serie',
	tests: null,
	index: 0,
	current: null,

	init: function(tests){
		this.tests = tests;
	},

	get count(){
		var i = 0, j = this.tests.length, count = 0, test;

		for(;i<j;i++){
			test = this.tests[i];
			if( TestSerie.isPrototypeOf(test) ){
				count+= test.count;
			}
			else{
				count++;
			}
		}

		return count;
	},

	augmentError: function(e){
		// nothing to do, the error come from a subtest
	},

	forEach: function(fn, bind){
		return this.tests.forEach(fn, bind);
	},

	createTest: function(){
		var test = this.Test.new.apply(this.Test, arguments);
		test.parent = this;
		return test;
	},

	add: function(){
		var test = this.createTest.apply(this, arguments);
		this.tests.push(test);
		return this;
	},

	setup: function(){
		this.index = 0;
		this.current = null;
	},

	teardown: function(){
		// something to do?
	},

	clean: function(){
		if( this.current ){
			this.current.stop();
		}
		TestPrototype.clean.call(this);
	},

	next: function(){
		if( this.index >= this.tests.length ){
			return null;
		}
		else{
			this.current = this.tests[this.index];
			this.index++;
			return this.current;
		}
	},

	nextTest: function(e){
		if( e ){
			this.fail(e);
		}
		else if( this.next() ){
			this.current.start(this.nextTest, this);
		}
		// all test passed with success or no test to run
		else{
			this.pass();
		}
	},

	run: function(){
		this.nextTest();
	}
});

module.exports = TestSerie;