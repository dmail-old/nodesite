<!--

Ce fichier est renvoyé à toute requête GET sauf:

- si l'URL débute par un dossier existant: '/css/*, /js/*, /img/*'
- si l'URL cible la racine et un fichier d'extension différente de .js: '/manifest.appcache'

Il consititue le cadre du site, on récup des infos depuis le serveur dans les {}
Une fois tout ceci fait on appele app.init pour afficher la page correspondante

-->

<!DOCTYPE html>

<html dir="ltr">

	<head>
		{metas}
		<title>{title}</title>
		{favicon}
		{styles}
		<script type="text/javascript" src="./js/lib/path.js"></script>
		<script type="text/javascript">

			window.NS = {};
			window.config = {config};
			window.lang = JSON.stringify({lang});
			// Function.reviver existe pas encore ici
			lang = JSON.parse(lang, function(key, value){
				return typeof value == 'string' && value.indexOf('(function (') === 0 ? eval(value) : value;
			});

			window.root = '.';//config.protocol + '://' + config.host + (config.port ? ':' + config.port : '');

			window.onerror = function(msg, url, line){
				//console.log('window error', arguments);
			};

			window.Module = function Module(id){
				this.id = id;
				this.filename = this.path.normalize(root + '/client/js/' + id + '.js');
				this.cache[this.filename] = this;
				this.pathCache[this.id] = this.filename;
			};

			window.Module.prototype.path = window.path;
			window.define = function(id, fn){
				var module = new Module(id);
				return fn.call(module, module.require.bind(module), module.filename);
			};
			
			window.Module.prototype.cache = {};			
			window.Module.prototype.require = function(id){
				var path = this.resolve(id);

				if( path in this.cache ){
					return this.cache[path].exports;
				}
				else{
					console.trace();
					throw new Error('unknow module ' + path);
				}
			};

			window.Module.prototype.pathCache = {};
			window.Module.prototype.resolve = function(id){
				if( id in this.pathCache ){
					return this.pathCache[id];
				}
				else{
					var path = this.path.resolve(this.path.dirname(this.filename), id);
					if( path.indexOf('.js', path.length - 3) === -1 ){
						path = path + '.js';
					}
					return this.pathCache[id] = path;
				}
			};

			define('.', function(require){
				window.module = window.mainModule = this;
				window.require = require;
			});

		</script>
	</head>

	<body>
		{scripts}
		<script>
			// app.init will be called once css and js have fully loaded
			window.onload = function(){
				// setTimeout is to avoid initial popstate event
				setTimeout(function(){ window.app.init.call(window.app); }, 0);
			};
		</script>
	</body>

</html>
