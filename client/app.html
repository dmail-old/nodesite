<!--

Ce fichier est renvoyé à toute requête GET sauf:

- si l'URL débute par un dossier existant: '/css/*, /js/*, /img/*'
- si l'URL cible la racine et un fichier d'extension différente de .js: '/manifest.appcache'

Il consititue le cadre du site, on récup des infos depuis le serveur dans les {}
Une fois tout ceci fait on appele app.init pour afficher la page correspondante

-->

<!DOCTYPE html>

<html dir="ltr">

	<head>
		{metas}
		<title>{title}</title>
		{favicon}
		{styles}
		<script type="text/javascript">
		var Path = {
	normalizeArray: function(parts, keepBlanks){
		var directories = [], prev, i = 0, j = parts.length - 1, directory;
		
		for(;i<=j;i++) {
			directory = parts[i];

			// if it's blank, but it's not the first thing, and not the last thing, skip it.
			if( directory === "" && i !== 0 && i !== j && !keepBlanks ) continue;

			// if it's a dot, and there was some previous dir already, then skip it.
			if( directory === "." && prev !== undefined ) continue;

			// if it starts with "", and is a . or .., then skip it.
			if( directories.length === 1 && directories[0] === "" && (directory === "." || directory === "..") ) continue;

			if( directory === ".." && directories.length && prev !== ".." && prev !== "." && prev !== undefined && (prev !== "" || keepBlanks) ){
				directories.pop();
				prev = directories.slice(-1)[0];
			}
			else{
				if( prev === "." ) directories.pop();
				directories.push(directory);
				prev = directory;
			}
		}
		
		return directories;
	},
	
	join: function(){
		return this.normalize(Array.prototype.join.call(arguments, '/'));
	},
	
	normalize: function(path, keepBlanks){
		return this.normalizeArray(path.split('/'), keepBlanks).join('/');
	},
	
	dirname: function(path){
		var lastSlash;
		
		if( path.length > 1 && path[path.length - 1] == '/' ) path = path.replace(/\/+$/, '');
		
		lastSlash = path.lastIndexOf('/');
		switch(lastSlash){
		case -1:
			return '.';
		case 0:
			return '/';
		default:
			return path.substring(0, lastSlash);
		}
	},
	
	basename: function(path, ext){
		var basename = path.substr(path.lastIndexOf('/') + 1);
		
		if( typeof ext == 'string' && basename.substr(basename.length - ext.length) === ext ){
			basename = basename.substr(0, basename.length - ext.length);
		}
		
		return basename;
	},
	
	extdot: function(path){
		var dot = path.lastIndexOf('.'), slash = path.lastIndexOf('/');
		
		return dot <= slash + 1 ? -1 : dot;
	},
	
	extname: function(path){
		var dot = this.extdot(path);
		
		return dot > -1 ? path.substring(dot) : '';
	},
	
	filename: function(path){
		return this.basename(path, this.extname(path));
	}
};

Path.resolve = function(){
	var resolvedPath = '', resolvedAbsolute = false, i = arguments.length - 1, path;

	while(i >= -1){
		path = i >= 0 ? arguments[i] : './'; //document.location.pathname;

		// Skip empty and invalid entries
		if( typeof path !== 'string' ){
			throw new TypeError('Arguments to path.resolve must be strings');
		}
		else if( !path ) {
			continue;
		}

		resolvedPath = path + '/' + resolvedPath;
		resolvedAbsolute = path.charAt(0) === '/';
		if( resolvedAbsolute ) break;

		i--;
	}

	// At this point the path should be resolved to a full absolute path, but
	// handle relative paths to be safe (might happen when process.cwd() fails)

	// Normalize the path
	resolvedPath = resolvedPath.split('/');
	resolvedPath = resolvedPath.filter(function(p){ return Boolean(p); });
	resolvedPath = this.normalizeArray(resolvedPath, !resolvedAbsolute);
	resolvedPath = resolvedPath.join('/');

	return ((resolvedAbsolute ? '/' : '') + resolvedPath) || '.';
};

Path.relative = function(from, to){
	var start, end, i, j, fromParts, toParts, length, samePartsLength, outputParts = [];

	function trim(arr) {
		start = 0;
		for(;start<arr.length;start++){
			if( arr[start] !== '' ) break;
		}
		end = arr.length - 1;
		for (; end >= 0; end--) {
			if (arr[end] !== '') break;
		}

		if( start > end ) return [];
		return arr.slice(start, end - start + 1);
	}

	from = this.normalize(from);
	to = this.normalize(to);
	fromParts = trim(from.split('/'));
	toParts = trim(to.split('/'));
	
	i = 0;
	samePartsLength = j = Math.min(fromParts.length, toParts.length);
	for(;i<j;i++){
		if( fromParts[i] !== toParts[i] ){
			samePartsLength = i;
			break;
		}
	}

	outputParts = [];
	i = samePartsLength;
	j = fromParts.length;
	for(;i<j;i++){
		outputParts.push('..');
	}

	outputParts = outputParts.concat(toParts.slice(samePartsLength));

	return outputParts.join('/');
};
		</script>
		<script type="text/javascript">

			window.NS = {};
			window.config = {config};
			window.lang = JSON.stringify({lang});
			// Function.reviver existe pas encore ici
			lang = JSON.parse(lang, function(key, value){
				return typeof value == 'string' && value.indexOf('(function (') === 0 ? eval(value) : value;
			});

			window.root = config.protocol + '://' + config.host + (config.port ? ':' + config.port : '');

			window.onerror = function(msg, url, line){
				//console.log('window error', arguments);
			};

			window.Module = function(path){
				this.cache[path] = this;
				this.path = path;
			};

			window.Module.prototype.cache = {};
			window.Module.prototype.resolve = function(path){
				return Path.resolve(Path.dirname(this.path), path);
			};
			window.Module.prototype.require = function(path){
				var path = this.resolve(path);

				if( path in this.cache ){
					return this.cache[path].exports;
				}
				else{
					throw new Error('unknow module ' + path);
				}
			};

			window.module = new Module('./');
			window.require = window.module.require.bind(window.module);

		</script>
	</head>

	<body>
		{scripts}
		<script>
			// app.init will be called once css and js have fully loaded
			window.onload = function(){
				// setTimeout is to avoid initial popstate event
				setTimeout(function(){ window.app.init.call(window.app); }, 0);
			};
		</script>
	</body>

</html>
