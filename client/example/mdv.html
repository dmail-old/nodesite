<style>
my-element{ display: none; }
my-template{ display: none; }
</style>

<script>
var Model = {
	data: {},

	create: function(data){
		this.watchers = {};
		this.collectionWatchers = {};
		this.setData(data || {});
	},

	setData: function(data){
		this.data = {};
		for(var key in data){
			this.set(key, data[key]);
		}
	},

	has: function(name){
		return name in this.data;
	},

	get: function(name){
		return this.data[name];
	},

	set: function(name, value){
		var old = this.get(name);

		if( Array.isArray(old) ){
			var length = old.length;
			while(length--){
				this.remove(name, 0);
			}
		}

		if( Array.isArray(value) ){
			var i = 0, j = value.length;
			for(;i<j;i++){
				this.add(name, value[i]);
			}
		}
		else{
			this.data[name] = value;
			if( name in this.watchers ) this.watchers[name](value);
		}
	},

	add: function(name, data){
		var list;

		if( this.has(name) ){
			list = this.get(name);
		}
		else{
			list = this.data[name] = [];
		}

		var model = Model.new(Object.append(Object.create(this.data), data));

		list.push(model);

		if( name in this.collectionWatchers ) this.collectionWatchers[name](model, false);

		return model;
	},

	remove: function(name, index){
		var list, model;

		if( this.has(name) ){
			list = this.get(name);
			model = list[index];
			list.splice(index, 1);

			if( name in this.collectionWatchers ) this.collectionWatchers[name](model, 'remove');
		}
	},

	watch: function(name, listener){
		this.watchers[name] = listener;
		listener(this.get(name), null);
	},

	watchCollection: function(name, listener){
		this.collectionWatchers[name] = listener;

		if( this.has(name) ){
			var list = this.get(name), i = 0, j = list.length;

			// simule que on a ajouter l'item à la liste
			for(;i<j;i++){
				listener(list[i], false);
			}
		}
	}
};

var Parser = {
	directives: {},

	collectDirectives: function(node, path){
		if( typeof path != 'string' ) path = '';

		var found = [], name, directive, terminal = false, nodeType = node.nodeType, i, result;

		for( name in this.directives ){
			directive = this.directives[name];

			if( directive.nodeType == nodeType ){
				result = directive.test(node)
				if( result != false ){

					found.push({
						name: name,
						path: path,
						result: result,
						link: directive.compile ? directive.compile(node) : directive.link
					});

					if( directive.terminal ) terminal = true;
				}
			}
		}

		// keep searching directives
		if( terminal === false && (nodeType == 1 || nodeType == 11) ){
			found = found.concat(this.collectChildNodesDirectives(node, path));
		}

		return found;
	},

	collectNodeListDirectives: function(nodeList, path){
		if( typeof path != 'string' ) path = '';
		else if( path != '' ) path+= '.';

		var found = [], i = 0, j = nodeList.length;

		for(;i<j;i++){
			found = found.concat(this.collectDirectives(nodeList[i], path + i));
		}

		return found;
	},

	collectChildNodesDirectives: function(node, path){
		return this.collectNodeListDirectives(node.childNodes, path);
	},

	parse: function(element, descendantOnly){
		var found;

		if( descendantOnly ){
			found = this.collectChildNodesDirectives(element);
		}
		else{
			found = this.collectDirectives(element);
		}

		return found;
	},

	register: function(name, directive){
		this.directives[name] = Directive.extend(directive);
	}
};

var Directive = {
	nodeType: 1,
	terminal: false,
	test: Function.TRUE,
	compile: null,
	link: Function.EMPTY
};

Parser.register('textnode', {
	nodeType: 3,

	test: function(node){
		var value = node.nodeValue.trim();

		if( value.startsWith('{') && value.endsWith('}') ){
			return value.substring(1, value.length - 1);
		}

		return false;
	},

	link: function(model, node, property){
		model.watch(property, function(value){
			node.nodeValue = value;
		});
	}
});

var Template = {
	content: null,
	directives: null,

	create: function(element){
		this.content = document.createDocumentFragment();

		/*
		var i = element.childNodes.length;
		while(i--){
			this.content.appendChild(element.childNodes[0]);
		}
		*/
		var i = 0, j = element.childNodes.length;
		for(;i<j;i++){
			this.content.appendChild(element.childNodes[i].cloneNode(true));
		}
	},

	parse: function(){
		if( this.directives == null ){
			this.directives = Parser.parse(this.content);
		}
		return this.directives;
	},

	findNode: function(node, path){
		if( path === '' ){
			return node;
		}

		var parts = path.split('.'), i = 0, j = parts.length;

		for(;i<j;i++){
			node = node.childNodes[parts[i]];
			if( node == null ){
				throw new Error('node not found');
			}
		}

		return node;
	},

	link: function(node, model){
		var directives = this.parse(), i = directives.length, directive;

		while(i--){
			directive = directives[i];
			directive.link(model, this.findNode(node, directive.path), directive.result);
		}
	},

	cloneContent: function(){
		return this.content.cloneNode(true);
	},

	clone: function(){
		return TemplateInstance.new(this, this.cloneContent());
	}
};

var TemplateInstance = {
	template: null,
	element: null, // documentfragment from template

	create: function(template, element){
		this.template = template;
		this.element = element;
		this.element.templateInstance = this;
		this.model = Model.new();
		this.template.link(this.element, this.model);
	},

	insert: function(parent){
		parent.appendChild(this.element);
	}
};

</script>

<!-- SIMPLE Template -->

<my-template id="template">
	Coucou <span>{name}</span>
</my-template>

<script>

var template = Template.new($('template'));
var clone = template.clone();

// lorsque je fait ceci, clone.element devient vide puisque ses enfant sont tous copié dans
// document.body
clone.insert(document.body);
clone.model.set('name', 'damien');

</script>

<!-- NESTED Template -->

<my-template id="othertemplate">
	Coucou <span>{name}</span>
	<my-template id="nestedtemplate">
	Gender: <span>{gender}</span>
	Age: <span>{age}</span>
	</my-template>
</my-template>

<script>

var otherTemplate = Template.new($('othertemplate'));
var clone = otherTemplate.clone();

clone.model.set('name', 'cassandre');
clone.insert(document.body);

var nestedTemplate = Template.new($('nestedtemplate'));

var nestedClone = nestedTemplate.clone();
nestedClone.insert(document.body);
nestedClone.model.setData({
	gender: 'fille',
	age: 18
});

</script>

<!-- REPEAT directive -->

<!-- REF directive -->
