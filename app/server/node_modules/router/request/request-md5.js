function createBadDigestError(digest, expected){
	var error = new Error();

	console.log(digest, expected);

	error.message = 'Bad digest error: md5 don\'t match: '+ digest +' != '+ expected;
	error.statusCode = 400;
	error.code = 'BAD_DIGEST';

	return error;
}

function checkMD5(request){
	var hash = require('crypto').createHash('md5').setEncoding('base64');

	request.stream.pause();
	request.stream.on('data', function(chunk, encoding){
		hash.write(chunk, encoding);
	});
	request.stream.on('end', function(){
		var digest = hash.digest(), md5 = request.md5;
		if( md5 != digest ){
			this.emit('error', createBadDigestError(digest, md5));
		}
	});
}

module.exports = {
	name: 'request-md5',

	properties: {
		autoMD5: true,

		get md5(){
			return this.getHeader('content-md5');
		}
	},

	task: function(){
		if( this.autoMD5 && this.hasHeader('content-md5') ){
			checkMD5(this);
		}
	}
};