module.exports = {
	name: 'requestMD5',

	request: {
		hash: null,

		get md5(){
			return this.getHeader('content-md5');
		},

		createBadDigestError: function(digest, expected){
			var error = new Error();

			console.log(digest, expected);

			error.message = 'Bad digest error: md5 don\'t match: '+ digest +' != '+ expected;
			error.statusCode = 400;
			error.code = 'BAD_DIGEST';

			return error;
		},

		checkMD5: function(){
			this.hash = require('crypto').createHash('md5').setEncoding('base64');

			this.stream.pause();
			this.stream.on('data', function(chunk, encoding){
				this.hash.write(chunk, encoding);
			}.bind(this));
			this.stream.on('end', function(){
				var digest = this.hash.digest();
				if( this.md5 != digest ){
					this.stream.emit('error', this.createBadDigestError(digest, this.md5));
				}
			}.bind(this));
		}
	},

	handle: function(handler){
		var request = handler.request;

		if( request.hasHeader('content-md5') ){
			request.checkMD5();
		}
	}
};