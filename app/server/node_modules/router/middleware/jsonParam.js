function parseJSON(json, urlEncoded){
	if( urlEncoded ){
		json = require('querystring').unescape(json);
	}

	try{
		json = JSON.parse(json);
	}
	catch(e){
		return e;
	}

	return json;
}

module.exports = {
	handle: function(){
		var request = this.request, params;

		params = request.urlParams;
		if( params && params.json ){
			params.json = parseJSON(params.json, true);

			if( params.json instanceof Error ) return this.error(params.json);
			if( request.params ) request.params.json = params.json;
		}

		params = request.bodyParams;
		if( params && params.json ){
			// decode URI component on json URI encoded string
			if( request.type == 'application/x-www-form-urlencoded' ){
				params.json = parseJSON(params.json, true);
			}
			else if( request.type == 'application/json' ){
				params.json = parseJSON(params.json);
			}

			if( params.json instanceof Error ) return this.error(params.json);
			if( request.params ) request.params.json = params.json;
		}

		this.next();
	}
};