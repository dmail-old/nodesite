/*

*/

var Module = {
	ModulePathResolver: require('./resolver'),

	cache: {},
	new: function(filename, parent){
		if( filename in this.cache ) return this.cache[filename];

		this.filename = filename;
		this.parent = parent;
		this.resolvedPaths = {};
		this.children = [];	

		if( parent ){
			parent.children.push(this);
		}

		this.cache[filename] = this;
	},

	createChild: function(filename){
		return Module.new(filename, this);
	},

	resolve: function(path, fn, bind){
		if( path in this.resolvedPaths ){
			process.nextTick(function(){
				fn.call(bind, null, this.resolvedPaths[path]);
			}.bind(this));
		}
		else{
			var resolver = new this.ModulePathResolver(this.filename, path);

			resolver.resolve(function(error, filename){
				if( error ){
					fn.call(bind, error);
				}
				else if( filename ){
					this.resolvedPaths[path] = filename;
					this.createChild(filename);
					fn.call(bind, filename);
				}
				else{					
					fn.call(bind, new Error('not found'));
				}
			}.bind(this));
		}
	},

	toJSON: function(){
		return {
			filename: this.filename,
			resolvedPaths: this.resolvedPaths,
			children: this.children
		};
	}
};

var headers = {
	module: 'x-module',
	resolve: 'x-resolve',
	resolveParent: 'x-resolve-parent'
};

module.exports = {
	Module: Module,

	handle: function(){
		var Path = require('path');

		if( this.request.hasHeader(headers.resolve) ){
			var module = Module.new(this.request.getHeader(headers.resolveParent));
			
			module.resolve(this.request.getHeader(headers.resolve), function(error, filename){
				if( error ){
					this.response.error(error);
				}
				else{
					// make filename relative to the client path folder
					filename = Path.relative(global.CLIENT_PATH, filename);
					this.response.end(filename);
				}
			}, this);
		}
		else if( this.request.hasHeader(headers.module) ){
			// get filename of module relative to client path
			var filename = Path.resolve(global.CLIENT_PATH, this.request.getHeader(headers.module));
			this.response.sendFile(path);
		}		
		else{
			this.next();
		}
	}
};