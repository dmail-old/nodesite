/*

MORE:

*/

var debug = require('debug');

module.exports = {
	name: 'page',

	properties: {
		Page: require('./Page'),
		Resolver: require('./PageResolver'),

		createPagePromise: function(path){
			var page = this.Page.create(this, path);
			return page.createPromise();
		}
	},

	task: function(handler){
		var request = handler.request;

		return handler.Resolver.create(request.url.pathname, global.CLIENT_PATH).resolve().then(function(filename){
			if( !request.isAjax() ){
				// redirect all non ajax page request to app.page
				debug('redirecting to app.page');
				return global.CLIENT_PATH + '/app.page.js';
			}
			return filename;
		}).then(function(filename){
			debug('create page promise for', filename);
			return handler.createPagePromise(filename);
		}.bind(this)).catch(function(error){
			if( error && error.code === 'PAGE_NOT_FOUND' ) return null; // next middleware will handle
			return Promise.reject(error);
		});
	}
};