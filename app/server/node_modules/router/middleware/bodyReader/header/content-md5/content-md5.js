var RequestHeader = require('./requestHeader');
var ContentMD5Header = RequestHeader.extend({
	name: 'content-md5',
	errorMessage: 'Bad digest error: Request {headerName} header did not match md5: {headerValue} != {digest}',
	errorStatusCode: 400, // bad request
	HashVerifiedStream: require('../hashVerifiedStream'),

	effect: function(){
		var hash = require('crypto').createHash('md5').setEncoding('base64');
		var hashVerifiedStream = new this.HashVerifiedStream(hash, this.value);

		hashVerifiedStream.createBadDigestError = function(digest){
			return this.createError(this.errorStatusCode, this.errorMessage, {
				digest: digest
			});
		}.bind(this);

		this.bodyReader.computedStream.chain(hashVerifiedStream);
	}
});

module.exports = ContentMD5Header;