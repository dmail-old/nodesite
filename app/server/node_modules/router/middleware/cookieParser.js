var CookieModule = require('cookie');

module.exports = {
	request: {
		cookieParams: {},

		parseCookie: function(cookies){
			try{
				return CookieModule.parseAll(cookies);
			}
			catch(e){
				return e;
			}
		},
	},

	response: {
		setCookie: function(options){
			var cookies = this.headers[this.HEADERS.SET_COOKIE];

			if( typeof cookies == 'string' ){
				cookies = [cookies];
			}
			else if( !Array.isArray(cookies) ){
				cookies = [];
			}

			var cookie = CookieModule.new(options);

			cookies.push(cookie.toString());

			this.headers[this.HEADERS.SET_COOKIE] = cookies;
		}
	},

	handle: function(router){
		var request = router.request, cookies = request.getHeader(router.HEADERS.COOKIE);

		if( cookies ){
			request.cookieParams = request.parseCookie(cookies);
			if( request.cookieParams instanceof Error ) return router.error(request.cookieParams);
		}
		
		router.next();
	}
};