/*
etagify: https://hacks.mozilla.org/2013/02/fantastic-front-end-performance-in-node-part-2-a-node-js-holiday-season-part-6/
*/

module.exports = {
	name: 'responseMD5',
	response: {
		autoMD5: false, // computeMD5 from body

		get md5(){
			return this.getHeader('content-md5');
		},

		set md5(md5){
			this.setHeader('content-md5', md5);
		}
	},

	handle: function(handler){
		handler.addTask(function(response){
			if( response.hasHeader('content-md5') || !response.autoMD5 ) return response;

			return new Promise(function(resolve, reject){
				var hash = require('crypto').createHash('md5').setEncoding('base64');

				response.stream.on('data', function(chunk, encoding){
					hash.update(chunk, encoding);
				});
				response.stream.on('end', function(chunk, encoding){
					response.md5 = hash.digest();
					resolve();
				});
			});

		});
	}
};