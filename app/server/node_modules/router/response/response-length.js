var debug = require('debug');

module.exports = {
	name: 'response-length',

	properties: {
		autoLength: true, // computeLength from response stream
		//generatingLength: false,

		get length(){
			return this.hasHeader('content-length') ? parseInt(this.getHeader('content-length'), 10) : 0;
		},

		set length(length){
			this.setHeader('content-length', length);
		}
	},

	task: function(){
		var response = this;

		if( response.autoLength && response.hasBody() && !response.hasHeader('content-length')  ){
			debug('prefetch response body to set length');
			return response.createBodyPromise().then(function(buffer){
				response.length = buffer.length;
			}.bind(response));
		}
	}
};