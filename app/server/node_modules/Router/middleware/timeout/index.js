module.exports = {
	name: 'timeout',

	request: {
		timeout: null,
		timer: null,

		setTimeout: function(ms){
			if( this.timer  ){
				throw new Error('a timer exists');
			}
			else{
				this.timer = setTimeout(this.expire.bind(this), ms);
			}
		},

		clearTimeout: function(){
			if( this.timer ){
				clearTimeout(this.timer);
				this.timer = null;
			}
		},

		expire: function(){
			this.clearTimeout();
			this.emit('timeout', this.response);
		},

		checkTimeout: function(){
			if( this.timeout ){
				this.setTimeout(this.timeout);
				this.response.on('end', this.clearTimeout.bind(this));
				this.on('timeout', function(response){
					response.statusCode = 408; // request timeout
					response.end();
				});
			}
		}
	},

	use: function(router, timeout){
		router.Request.prototype.timeout = timeout;
	},

	handle: function(request, response, handler){
		request.checkTimeout();
		handler.next();
	}
};