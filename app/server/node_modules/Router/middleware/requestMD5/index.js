module.exports = {
	name: 'requestMD5',

	request: {
		hash: null,

		get md5(){
			return this.getHeader('content-md5');
		},

		createBadDigestError: function(digest, expected){
			var error = new Error();

			error.message = 'Bad digest error: md5 don\'t match: {digest} != {expected}';
			error.data = {
				digest: digest,
				expected: expected
			};
			error.statusCode = 400;
			error.code = 'BAD_DIGEST';

			return error;
		},

		checkMD5: function(){
			this.hash = require('crypto').createHash('md5').setEncoding('base64');

			this.on('data', function(chunk, encoding){
				this.hash.write(chunk, encoding);
			});

			this.on('end', function(){
				var digest = this.hash.digest();
				if( this.md5 != digest ){
					this.emit('error', this.createBadDigestError(digest, this.md5));
				}
			});
		}
	},

	handle: function(request){
		request.checkMD5();
	}
};