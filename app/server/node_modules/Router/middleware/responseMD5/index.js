/*
etagify: https://hacks.mozilla.org/2013/02/fantastic-front-end-performance-in-node-part-2-a-node-js-holiday-season-part-6/
*/

var MD5Generator = {
	hash: null,

	constructor: function(){
		this.hash = require('crypto').createHash('md5').setEncoding('base64');
	},

	ondata: function(chunk, encoding){
		this.hash.update(chunk, encoding);
	},

	onend: function(){
		this.response.md5 = this.hash.digest();
	}
};

module.exports = {
	response: {
		autoMD5: false, // computeMD5 from body

		get md5(){
			return this.getHeader('content-md5');
		},

		set md5(md5){
			this.setHeader('content-md5', md5);
		},

		generateMD5Header: function(){
			if( false === this.hasHeader('content-md5') && this.autoMD5 ){
				this.wait(MD5Generator);
			}
		}	
	},

	handle: function(request, response, handler){
		response.on('beforeSendingHeaders', response.generateMD5Header);
		handler.next();
	}
};