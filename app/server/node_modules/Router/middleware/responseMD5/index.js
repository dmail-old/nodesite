/*
etagify: https://hacks.mozilla.org/2013/02/fantastic-front-end-performance-in-node-part-2-a-node-js-holiday-season-part-6/
*/

module.exports = {
	response: {
		autoMD5: false, // computeMD5 from body

		get md5(){
			return this.getHeader('content-md5');
		},

		set md5(md5){
			this.setHeader('content-md5', md5);
		},

		generateMD5Header: function(){
			if( false === this.hasHeader('content-md5') && this.autoMD5 ){
				this.wait(function(done){					
					var hash = require('crypto').createHash('md5').setEncoding('base64');

					this.on('write', function(chunk, encoding){
						hash.update(chunk, encoding);
					});
					this.on('end', function(){
						this.md5 = hash.digest();
						done();
					});
				});
			}
		}	
	},

	handle: function(request, response, handler){
		response.on('beforeSendingHeaders', response.generateMD5Header);
		handler.next();
	}
};