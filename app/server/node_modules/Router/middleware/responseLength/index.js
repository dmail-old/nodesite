module.exports = {
	response: {
		autoLength: true, // computeLength from body

		get length(){
			return this.hasHeader('content-length') ? parseInt(this.getHeader('content-length'), 10) : 0;
		},

		set length(length){
			this.setHeader('content-length', length);
		},

		generateLengthHeader: function(){
			if( false === this.hasHeader('content-length') && this.autoLength ){
				this.wait(function(done){
					var length = 0;

					this.on('write', function(chunk, encoding){
						length+= Buffer.isBuffer(chunk) ? chunk.length : Buffer.byteLength(chunk, encoding);
					});
					this.on('end', function(){
						this.length = length;
						done();
					});
				});	
			}
		}	
	},

	handle: function(request, response, next){
		response.on('beforeSendingHeaders', response.generateLengthHeader);
		next();
	}
};