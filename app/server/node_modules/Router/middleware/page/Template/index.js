/*

TODO:

getContent devrait Ãªtre asynchrone

*/

require('Object.toSource');
var Template = {
	fileSystem: require('fs'),
	content: null,
	result: null,

	HTMLTemplate: require('./MustachePercentTemplate'),
	ScriptTemplate: require('./MustachePercentTemplate').create({
		stringify: function(value){
			return value.toSource();
		}
	}),

	// metas utilisant l'attribut "http-equiv"
	http_equiv: [
		'content-language',
		'content-type',
		'refresh',
		'pragma',
		'expires',
		'cache-control',
		'cache'
	],
	metaTemplate: '<meta {attr}="{name}" content="{value}" />',
	tags: {
		favicon: '<link href="#" type="image/x-icon" rel="shortcut icon"/>',
		style: '<link href="#" type="text/css" rel="stylesheet" />',
		script: '<script src="#" type="text/javascript"></script>',
		module: '<script src="#" type="text/module"></script>'
	},

	init: function(path){
		this.path = path;
	},

	setTagUrl: function(tag, path){
		var url = require('url').format({
			protocol: config.protocol,
			host: config.host + (config.port ? ':' + config.port : ''),
			pathname: path
		});

		return tag.replace('#', url);
	},

	renderTag: function(type, name){
		return this.setTagUrl(this.tags[type], name);
	},

	renderTags: function(type, names){
		var output = [];

		names.forEach(function(name){
			output.push(this.renderTag(type, name));
		}, this);

		return output.join('\n\t');
	},

	renderMetaTag: function(name, value){
		name = name.toLowerCase();
		var attr = 'name', meta;

		if( this.http_equiv.contains(name) ){
			attr = 'http-equiv';
			name = name.capitalize();
		}

		if( name == 'charset' ){
			return '<meta charset="' + value + '" />';
		}

		return this.metaTemplate.render({
			attr: attr,
			name: name,
			value: value
		});
	},

	renderMetaTags: function(metas){
		var output = [], name;

		for(name in metas){
			output.push(this.renderMetaTag(name, metas[name]));
		}

		return output.join('\n\t');
	},

	getContent: function(){
		this.content = this.fileSystem.readFileSync(this.path);
		this.content = this.content.toString(config.charset);
	},

	renderHTMLOnly: function(html, params){
		return this.HTMLTemplate.new(html).render(params);
	},

	renderScriptTagContent: function(script, params){
		return this.ScriptTemplate.new(script).render(params);
	},

	scriptTagRegExp: /(<script[^>]*>[\s\S]*?<\/script>)/gi,
	render: function(params){
		this.getContent();

		var content = this.content;
		
		// split the file into parts: "foo<script>alert('ok');</script>bar"
		// will output parts = ["foo", "<script>alert('ok');</script>", "bar"]
		var parts = content.split(this.scriptTagRegexp);

		// for each part replace "{%%}" with params
		parts.map(function(part, index){
			if( index % 2 === 0 ){
				return this.renderHTMLOnly(part, params);
			}
			else{
				return this.renderScriptTagContent(part, params);
			}
		}, this);

		return this.result = parts.join('');
	},

	toString: function(){
		return this.result;
	}
};

module.exports = Template;