/*

MORE:

*/

var debug = require('debug');

module.exports = {
	name: 'page',
	Page: require('./Page'),

	response: {
		createPagePromise: function(path){
			var page = new this.Page(this.handler, path);
			return page.createPromise();
		},

		sendPage: function(path){
			return this.send(this.createPagePromise(path));
		}
	},

	Resolver: require('./PageResolver'),

	handle: function(handler){
		var request = handler.request, response = handler.response;
		response.Page = this.Page;

		var resolver = this.Resolver.new(request.url.pathname, global.CLIENT_PATH);

		return resolver.resolve().then(function(filename){
			// redirect all non ajax page request to app.page
			if( request.isAjax() === false ){
				debug('redirecting to app.page');
				return global.CLIENT_PATH + '/app.page.js';
			}
			return filename;
		}).then(function(filename){
			return response.createPagePromise(filename);
		}).catch(function(error){
			if( error && error.code === 'PAGE_NOT_FOUND' ) return null; // next middleware will handle
			return Promise.reject(error);
		});
	}
};