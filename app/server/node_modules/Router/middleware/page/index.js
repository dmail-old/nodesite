/*

MORE:

*/

module.exports = {
	name: 'page',
	Page: require('./Page'),

	response: {
		createPagePromise: function(path){
			var page = new this.Page(this.handler, path);

			return page.createPromise().then(function(result){
				// default text/html
				if( false === this.hasHeader('content-type') ){
					this.setHeader('content-type', 'text/html');
				}
				return result;
			}.bind(this)).catch(function(error){
				if( error && error.code == 'MODULE_NOT_FOUND' ) return 404;
				return Promise.reject(error);
			});
		},

		sendPage: function(path){
			return this.send(this.createPagePromise(path));
		}
	},

	Resolver: require('./PageResolver'),

	handle: function(request, response){
		response.Page = this.Page;

		var resolver = this.Resolver.new(request.url.pathname, global.CLIENT_PATH);

		return resolver.resolve().then(function(filename){
			// redirect all non ajax page request to app.page
			if( request.isAjax() === false ) return 'app.page.js';
			return filename;
		}).then(function(filename){
			return response.createPagePromise(global.CLIENT_PATH + '/' + filename);
		}).catch(function(error){
			if( error && error.code === 'PAGE_NOT_FOUND' ) return null; // next middleware will handle
			return Promise.reject(error);
		});
	}
};