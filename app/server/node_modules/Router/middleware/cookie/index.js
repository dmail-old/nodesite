var Cookie = require('cookie');

module.exports = {
	request: {
		cookieParams: {},

		parseCookie: function(cookies){
			return Cookie.parseAll(cookies);
		}
	},

	response: {
		createCookie: function(){
			return Cookie.new.apply(Cookie, arguments);
		},

		addCookie: function(cookie){
			if( false === Cookie.isPrototypeOf(cookie) ){
				throw new TypeError('cookie expected');
			}

			var cookies = this.headers['set-cookie'];

			if( typeof cookies == 'string' ){
				cookies = [cookies];
			}
			else if( !Array.isArray(cookies) ){
				cookies = [];
			}

			cookies.push(cookie.toString());
			this.headers['set-cookie'] = cookies;
			return cookie;
		}
	},

	handle: function(request, response, handler){
		var cookies = request.getHeader('cookie');

		if( cookies ){
			request.cookieParams = request.parseCookie(cookies);
		}
		
		handler.next();
	}
};