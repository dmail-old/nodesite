function parseJSON(json, urlEncoded){
	if( urlEncoded ){
		json = require('querystring').unescape(json);
	}

	try{
		json = JSON.parse(json);
	}
	catch(e){
		return e;
	}

	return json;
}

module.exports = {
	handle: function(router){
		var request = router.request, urlParams, bodyParams;

		urlParams = request.urlParams;
		if( urlParams && urlParams.json ){
			urlParams.json = parseJSON(urlParams.json, true);

			if( urlParams.json instanceof Error ) return router.error(urlParams.json);
			//if( request.params ) request.params.json = params.json;
		}

		bodyParams = request.bodyParams;
		if( bodyParams && bodyParams.json ){
			// decode URI component on json URI encoded string
			if( request.mediaType == 'application/x-www-form-urlencoded' ){
				bodyParams.json = parseJSON(bodyParams.json, true);
			}
			else{
				bodyParams.json = parseJSON(bodyParams.json);
			}

			if( bodyParams.json instanceof Error ) return router.error(bodyParams.json);
			//if( request.params ) request.params.json = params.json;
		}

		router.next();
	}
};