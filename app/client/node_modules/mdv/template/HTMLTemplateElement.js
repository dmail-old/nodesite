var TemplateElement = window.HTMLTemplateElement;

if( typeof TemplateElement === 'undefined' ){
	TemplateElement = window.HTMLTemplateElement = function(){
		throw TypeError('Illegal constructor');
	};
	TemplateElement.supported = false;
}
else{
	TemplateElement.supported = true;
}

Object.append(TemplateElement, {
	Template: require('./template'),
	nativeAttribute: 'native',
	templateAttribute: 'template',
	contentDescriptor: {
		get: function(){
			var fragment = this.ownerDocument.createDocumentFragment();
			while( this.firstChild ){
				fragment.appendChild(this.firstChild);
			}
			return fragment;
		}
	},

	isNativeTemplateElement: function(node){
		return this.supported && node.tagName == 'TEMPLATE';
	},

	mixin: function(to, from){
		Object.getOwnPropertyNames(from).forEach(function(name) {
			Object.defineProperty(to, name, Object.getOwnPropertyDescriptor(from, name));
		});
	},

	isDecorated: function(node){
		return node.constructor == TemplateElement;
	},

	decorate: function(node){
		if( !this.isNativeTemplateElement(node) || !this.isDecorated(node) ){
			this.mixin(node, TemplateElement.prototype);
			// redefine 'content' to get the custom content descriptor, not the native one
			if( this.supported ){
				Object.defineProperty(node, 'content', this.contentDescriptor);
			}
		}
	},

	isTemplate: function(node){
		if( node.nodeType != 1 ) return false;
		if( node.hasAttribute(this.nativeAttribute) ) return false;
		return node.tagName == 'TEMPLATE' || node.hasAttribute(this.templateAttribute);
	},

	checkNode: function(node, found){
		if( this.isTemplate(node) ){
			found.push(node);
		}
		else{
			return this.checkChildNodes(node, found);
		}
	},

	checkNodeList: function(nodeList, found){
		var i = 0, j = nodeList.length;
		for(;i<j;i++){
			this.checkNode(nodeList[i], found);
		}
		return found;
	},

	checkChildNodes: function(node, found){
		return this.checkNodeList(node.childNodes, found);
	},

	collect: function(element){
		return this.checkChildNodes(element, []);
	},

	createTemplate: function(node){
		return this.Template.new(node);
	},

	createAll: function(list){
		var i = 0, j = list.length, node;
		for(;i<j;i++){
			this.createTemplate(list[i]);
		}
	},

	bootstrap: function(element){
		this.createAll(this.collect(element));
	}
});

if( typeof window.HTMLUnknownElement === 'undefined' ){
	window.HTMLUnknownElement = window.HTMLElement;
}
if( TemplateElement.supported === false ){
	TemplateElement.prototype = Object.create(window.HTMLUnknownElement.prototype);
	Object.defineProperty(TemplateElement.prototype, 'content', this.contentDescriptor);
}

TemplateElement.prototype.getReference = function(){
	var node = this, ref = this, id = this.getAttribute('ref'), nextRef;

	if( id ){
		node = document.getElementById(id);
		if( node ){
			ref = node;
		}
	}

	if( ref != this ){
		nextRef = ref.getReference();
		if( nextRef ) ref = nextRef;
	}

	return ref;
};
