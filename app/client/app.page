/*

Ce que fait youtube est plutot cool il envoit une requête AJAX
et recoit css, html, title, js ensuite il a pu qu'à mettre le CSS et le HTML ou il faut le script aussi

*/

module.exports = {
	title: 'coucou',

	GET: function(){
		var metas = {
			'charset': config.charset,
			'content-type': 'text/html',
			'content-language': config.lang,
			'description': lang.metas.description,
			'keywords': lang.metas.keywords,
			'robots': config.robot || 'all'
			// viewport: 'width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=1;' // pour les portables
		};

		// si on est en local ceci évite la mise en cache qui est pénible
		if( config.local ){
			metas['cache-control'] = metas['pragma'] = 'no-cache';
			// metas['cache'] = 'no store';
			metas['expires'] = 0;
		}

		var jsFiles = config.js;

		if( config.debug_modules ){
			var testFiles = require('fs.extra').readdirSyncRecursive(global.CLIENT_PATH + '/tests');
			testFiles = testFiles.map(function(fileName){ return fileName.slice(global.CLIENT_PATH.length); });
			testFiles.unshift('node_modules/tester.js');
			jsFiles = jsFiles.concat(testFiles);
		}

		// les fichiers js proviendront à la fois des dossier test/
		// mais seront aussi automatiquement injecté, voir dans node_modules.dependencies

		jsFiles = [];

		var page = this.createHTMLPage('html/app.html');
		page.setParams({
			'metas': page.parseMetas(metas),
			'title': lang.metas.title,
			'favicon': page.setTagUrl(page.tags.favicon, 'favicon.png'),
			'styles': page.parseStyles(config.css),
			'head_scripts': page.parseScripts([
				'js/path',
				'js/module'
			]),
			'scripts': page.parseScripts(jsFiles),
			// on auras plus besoin de JSON.stringify, si ce qu'on veut remplacer
			// est dans une balise script on fait automatiqueent JSON.stringify avec un replacer
			// qui mettras les fonctions aussi sous forme de chaine 
			'lang': JSON.stringify(lang, Function.replacer),
			'config': JSON.stringify({
				'protocol': config.protocol,
				'host': config.host,
				'port': config.port
			})
		});
		page.send();
	}
};