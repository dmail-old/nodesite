<!DOCTYPE html>

<html dir="ltr">

	<head>
		{%metas%}
		<title>{%title%}</title>
		<link href="{%origin%}/{%favicon%}" type="image/x-icon" rel="shortcut icon"/>
		{%styles%}
	</head>

	<body>
		<noscript>
			Javascript is disabled this app will not work
		</noscript>

		<div id="page">

		</div>

		<script type="text/javascript">
			window.config = {%config%};
			window.lang = {%lang%};
			window.onerror = function(message, url, line){
				//console.log('window error', arguments);
			};
		</script>
		<script src="{%origin%}/js/url.js" type="text/javascript"></script>
		<script src="{%origin%}/js/module.js" type="text/javascript"></script>
		<script type="text/javascript">
			window.$ = document.getElementById.bind(document);
			document.html = document.documentElement;

			// app.init will be called once js&css have fully loaded
			// setTimeout is to avoid any initial popstate event
			window.onload = function(){	setTimeout(function(){

				Module.prototype.preload = function(callback){
					var module = this, xhr = new XMLHttpRequest();

					xhr.open('GET', this.url, true);
					xhr.onreadystatechange = function(){
						if( this.readyState == 4 ){
							if( this.status >= 200 || this.status < 400 ){
								module.source = xhr.responseText;
								callback.call(module);
							}
							else{
								callback.call(module, new Error('not found'));
							}
						}
					};
				};

				function preloadModules(resolveds, onend){
					var i = 0, j = resolveds.length, count = 0, module;

					if( j === 0 ) return onend();

					function onpreload(error){
						count++;
						if( count === j - 1 ){
							onend();
						}
					}

					for(;i<j;i++){
						resolved = resolveds[i];

						var k = 0, l = resolved.urls.length;
						for(;k<l;l++){
							window.module.resolvedURLS[resolved.urls[k]] = resolved.target;
						}

						module = window.module.createChild(url.target);
						module.preload(onpreload);
					}
				}

				/*
				NAAAAAAN voilà ce qui faut:

				var resolvedURLS = {
					"app": "node_modules/app",
					"./app": "node_modules/app",
					"mdv": "node_modules/mdv/index.js" 
				};

				-> je le met en cache pour éviter des resolves

				var modules = [
					"node_modules/app",
					"node_modules/mdv/index.js"
				];

				-> je le met en cache pour éviter de les load

				-> avantage: je garde la logique de resolve et de load séparé
				je n'ai pas besoin de lire le module pour un module qui se resolve à la même url
				-> inconvénient: deux requête par module différent
				*/

				var resolvedModuleURLS = {%resolvedModuleURLS%};			

				preloadModules(resolvedModuleURLS, function(){
					require('app').app.init();
				});

			}, 0};
		</script>

		{%scripts%}

	</body>

</html>
