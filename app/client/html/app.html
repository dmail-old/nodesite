<!DOCTYPE html>

<html dir="ltr">

	<head>
		{%metas%}
		<title>{%title%}</title>
		<link href="{%origin%}/{%favicon%}" type="image/x-icon" rel="shortcut icon"/>
		{%styles%}
	</head>

	<body>
		<noscript>
			Javascript is disabled this app will not work
		</noscript>

		<div id="page">

		</div>

		<script type="text/javascript">
			window.config = {%config%};
			window.lang = {%lang%};
			window.onerror = function(message, url, line){
				//console.log('window error', arguments);
			};
		</script>
		<script src="{%origin%}/js/url.js" type="text/javascript"></script>
		<script src="{%origin%}/js/module.js" type="text/javascript"></script>
		<script type="text/javascript">
			window.$ = document.getElementById.bind(document);
			document.html = document.documentElement;

			// app.init will be called once js&css have fully loaded
			// setTimeout is to avoid any initial popstate event
			window.onload = function(){	setTimeout(function(){

				Module.prototype.preload = function(callback){
					var module = this, xhr = new XMLHttpRequest();

					var xhr = module._load(true);

					xhr.open('GET', this.url, true);
					xhr.onreadystatechange = function(){
						if( this.readyState == 4 ){
							if( this.status >= 200 || this.status < 400 ){
								module.source = xhr.responseText;
								callback.call(module);
							}
							else{
								callback.call(module, new Error('not found'));
							}
						}
					};
				};

				function preloadModules(modules, onend){
					var i = 0, j = modules.length, count = 0, module;

					if( j === 0 ) return onend();

					function onpreload(error){
						count++;
						if( count === j - 1 ){
							onend();
						}
					}

					for(;i<j;i++){
						module = window.module.createChild(window.module.resolve(modules[i]));
						module.preload(onpreload);
					}
				}

				window.module.resolvedURLS = {%moduleURLS%};
				preloadModules({%modules%}, function(){
					require('app').app.init();
				});

			}, 0};
		</script>

		{%scripts%}

	</body>

</html>
