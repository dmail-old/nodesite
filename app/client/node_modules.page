/*

if .js not specified it looks for pathname + '/index.js' then pathname + '.js'
it will try to locate those files in app/client/node_modules then app/node_modules

*/

var ModuleDemand = {
	Path: require('path'),
	fileSystem: require('fs'),

	demand: null,
	name: null,

	dirname: 'node_modules',
	prefix: 'var mod = new Module("{filename}");\n\n(function(exports, require, module, __filename, __dirname){\n\n',
	suffix: '\n\n}).call(mod.exports, mod.exports, mod.require.bind(mod), mod, mod.filename, mod.dirname);\n',

	create: function(request, response){
		this.request = request;
		this.response = response;
		this.name = request.url.pathname.slice(('/' + this.dirname + '/').length);
	},

	wrapStream: function(readableStream, prefix, suffix){
		var encoding = 'utf8';
		var transformStream = new require('stream').Transform();
		var data = '';
		
		transformStream._transform = function(chunk, encoding, done){
			data+= chunk;
			done();
		};
		transformStream._flush = function(done){
			data = prefix + data + suffix;
			this.push(data, encoding);
			done();
		};

		readableStream.setEncoding(encoding);
		readableStream.pipe(transformStream);

		return transformStream;
	},

	sendFile: function(path){
		var pathname = path.replace(/\\/g, '/');
		var search = '/'+ this.dirname +'/';
		var filepath = pathname.slice(pathname.indexOf(search) + search.length);
		var prefix = this.prefix.replace('{filename}', filepath);
		var suffix = this.suffix.replace('{filename}', filepath);
		var response = this.response;

		response.on('body', function(body){
			// let content-length be auto generated
			this.removeHeader('content-length');
			this.body = Buffer.concat([new Buffer(prefix), body, new Buffer(suffix)]);
		});

		response.sendFile();
	},

	// TODO put the result in cache
	resolve: function(filename, callback, bind){
		bind = bind || this;
		var fileSystem = this.fileSystem;
		var Path = this.Path;
		var self = this;
		var sharedNodeModulesDirectory = global.APP_PATH;
		var clientNodeModulesDirectory = global.CLIENT_PATH;
		var extension = Path.extname(filename);
		var checkDirectory = extension === '';
		var checkNodeModules = startsWith(filename, '/', './', '../', sharedNodeModulesDirectory) === false;
		if( !checkDirectory ) filename = Path.dirname(filename) + Path.sep + Path.basename(filename, extension);

		var clientModule = clientNodeModulesDirectory + Path.sep + this.dirname + Path.sep + filename;
		var sharedModule = sharedNodeModulesDirectory + Path.sep + this.dirname + Path.sep + filename;		
		
		function searchFile(filePath, fn){
			fileSystem.stat(filePath, function(error){
				if( error ){
					fn();
				}
				else{
					fn(filePath);
				}
			});
		}

		function startsWith(str){
			var i = 1, j = arguments.length;
			for(;i<j;i++){
				if( str.startsWith(arguments[i]) ) return true;
			}
			return false;
		}

		function searchModule(modulePath, fail){
			searchFile(modulePath + '.js', function(validPath){
				if( validPath ){
					return callback.call(bind, validPath);
				}

				if( checkDirectory ){
					return searchFile(modulePath + Path.sep + 'index.js', function(validPath){
						if( validPath ){
							return callback.call(bind, validPath);
						}
						else{
							fail();
						}				
					});
				}

				fail();
			});
		}

		searchModule(clientModule, function(){
			if( checkNodeModules ){
				searchModule(sharedModule, function(){
					callback.call(bind);
				});
			}
			else{
				callback.call(bind);
			}			
		});
	},

	send: function(){
		this.resolve(this.name, function(modulePath){
			if( modulePath ){
				this.sendFile(modulePath);
			}
			else{
				this.response.send(404);
			}
		});
	}	
};

module.exports = function(){
	ModuleDemand.new(this.request, this.response).send();
};