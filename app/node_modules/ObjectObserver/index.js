var WeakMap = require('../../client/node_modules/WeakMap');
var Emitter = require('Emitter');
var ObjectObserver = Emitter.create({
	modelInstance: new WeakMap(),

	new: function(model){
		var instance = this.modelInstance.get(model);

		if( !instance ){
			instance = Object.prototype.new.call(this, model);
			this.modelInstance.set(model, instance);
			return instance;
		}

		return instance;
	},

	init: function(model){
		Emitter.init.call(this, model);
	},

	watcher: function(name, oldValue, value){
		if( oldValue !== value ){
			this.emit(name, name, oldValue, value);
		}
		return value;
	},

	toString: function(){
		return 'ObjectObserver';
	}
});

require('Object.watch');
ObjectObserver.on('addListener', function(name, listener){
	// if it's the first listener
	if( this.listeners(name).length == 1 ){
		Object.prototype.watch.call(this.bind, name, this.watcher.bind(this));
	}
});
ObjectObserver.on('removeListener', function(name, listener){
	// if it's the last listener
	if( this.listeners(name) === false ){
		Object.prototype.unwatch.call(this.bind, name);
		if( Object.isEmpty(this.$listeners) ){
			this.modelInstance.delete(this.bind);
		}
	}
});

module.exports = ObjectObserver;