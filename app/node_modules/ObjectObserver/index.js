var WeakMap = require('../../client/node_modules/WeakMap');
var Emitter = require('Emitter');
var ObjectObserver = Emitter.create({
	modelInstance: new WeakMap(),

	new: function(model){
		var instance = this.modelInstance.get(model);

		if( !instance ){
			instance = Emitter.new.call(this, model);
			this.modelInstance.set(model, instance);
			return instance;
		}

		return instance;
	},

	init: function(model){
		Emitter.init.call(this, model);
	},

	watcher: function(name, value, oldValue, object){
		if( oldValue !== value ){
			this.emit(name, name, oldValue, value, object);
		}
	},

	toString: function(){
		return 'ObjectObserver';
	}
});

var propertyWatcher = require('Object.watch');
ObjectObserver.on('addListener', function(name, listener){
	// if it's the first listener
	if( this.listeners(name).length == 1 ){
		propertyWatcher.watch(this.bind, name, this.watcher, this);
	}
});
ObjectObserver.on('removeListener', function(name, listener){
	// if it's the last listener
	if( this.listeners(name) === false ){
		propertyWatcher.unwatch(this.bind, name);
		if( Object.isEmpty(this.$listeners) ){
			this.modelInstance.delete(this.bind);
		}
	}
});

module.exports = ObjectObserver;