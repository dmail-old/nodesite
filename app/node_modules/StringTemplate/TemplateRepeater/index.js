var proto = require('proto');

var TemplateRepeater = proto.create({
	Template: require('StringTemplate'),
	template: null,
	separator: null,
	array: null,
	map: null,
	bind: null,

	init: function(template, separator){
		if( typeof template == 'string' ) template = this.Template.new(template);
		this.template = template;
		this.separator = separator;
	},

	exec: function(array, fn, bind){
		this.array = array;
		this.map = fn;
		this.bind = bind;
		return this;
	},

	reduce: function(fn, buffer){
		var array = this.array, i = 0, j = array.length, log;

		for(;i<j;i++){
			log = this.new(this);
			log.scope = array[i];
			if( this.map ){
				log = this.map.call(this.bind, log, i, this);
			}

			buffer = fn(buffer, log, i != j-1 ? this.separator : '', i, array);
		}

		return buffer;
	},

	toString: function(){
		return this.reduce(function(previous, current, separator, index, array){
			return previous + current.toString() + separator;
		}, '');
	},

	toStylizedString: function(){
		return this.reduce(function(previous, current, separator, index, array){
			return previous + current.toStylizedString() + separator;
		}, '');
	}
});

TemplateRepeater.Template.repeat = function(array, separator, fn, bind){
	return TemplateRepeater.new(this, separator).exec(array, fn, bind);
};

module.exports = TemplateRepeater;