/*



*/

var proto = require('proto');

var ExpressionsResolver = {
	rawExpression: function(expression){
		return '{' + expression + '}';
	},

	getExpressionValueInNull: function(expression){
		return this.rawExpression(expression);
	},

	getExpressionValueInArray: function(expression, array, index){
		if( index in array ) return array[index];
		return this.rawExpression(expression);
	},

	getExpressionValueInObject: function(expression, object, index){
		// replace 'name' by object.name
		if( expression in object ) return object[expression];
		// replace 'name' by '{name}'
		return this.rawExpression(expression);
	},

	resolve: function(expressions, scope, map, bind){
		var i = 0, j = expressions.length, values = new Array(j), value, getter;

		if( scope == null ){
			getter = this.getExpressionValueInNull;
		}
		else if( scope instanceof Array ){
			getter = this.getExpressionValueInArray;
		}
		else{
			getter = this.getExpressionValueInObject;
		}

		for(;i<j;i++){
			value = getter.call(this, expressions[i], scope, i);
			if( map ) value = map.call(bind, value, i, scope);
			values[i] = value;
		}

		return values;
	}
};

var Renderer = {
	reduce: function(strings, values, fn, bind, buffer){
		var i = 0, j = values.length, string, value;

		while(i<j){
			value = String(values[i]);
			string = strings[i + 1];
			buffer = fn.call(bind, buffer, value, string, i);
			i++;
		}

		return buffer;
	},

	stringReducer: function(prev, value, string){
		return prev + value + string;
	},

	arrayReducer: function(prev, value, string){
		prev.push(value, string);
		return prev;
	},

	renderAsString: function(strings, values){
		return this.reduce(strings, values, this.stringReducer, this, strings[0]);
	},

	renderAsArray: function(strings, values){
		return this.reduce(strings, values, this.arrayReducer, this, [strings[0]]);
	}
};

var TemplateResult = proto.create({	
	Resolver: ExpressionsResolver,
	Renderer: Renderer,	
	template: null,
	strings: null,
	expressions: null,
	scope: null,
	map: null,
	bind: null,
	_values: null,

	new: function(template){
		this.template = template;

		this.strings = template.strings;
		this.expressions = template.expressions;
		this.scope = template.scope;
		this.map = template.map;
		this.bind = template.bind;
	},

	// ondemand values
	get values(){
		var value = this._values;
		if( value === null ){
			value = this.Resolver.resolve(this.expressions, this.scope, this.map, this.bind);
			this._values = value;
		}
		return value;
	},

	toString: function(){
		return this.Renderer.renderAsString(this.strings, this.values);
	},

	toArray: function(){
		return this.Renderer.renderAsArray(this.strings, this.values);
	}
});

var StringTemplate = proto.create({
	Compiler: require('./Compiler'),
	Result: TemplateResult,
	string: null,
	scope: null,
	map: null,
	bind: null,

	init: function(string){
		this.string = string;
	},

	compile: function(string){
		return this.Compiler.compile(string);
	},

	'@compilationResult': function(){
		return this.compile(this.string);
	},

	'@result': function(){
		return this.createResult(this); 
	},

	set strings(value){
		this.compilationResult.strings = value;
	},

	set expressions(value){
		this.compilationResult.expressions = value;
	},

	get strings(){
		return this.compilationResult.strings;
	},

	get expressions(){
		return this.compilationResult.expressions;
	},

	createResult: function(){
		return this.Result.new.apply(this.Result, arguments);
	},

	toString: function(){
		return this.result.toString();
	},

	toArray: function(){
		return this.result.toArray();
	},

	exec: function(scope, map, bind){
		this.scope = scope;
		this.map = map;
		this.bind = bind;
		this.result = this.createResult(this);
		return this.result;
	},

	render: function(scope, map, bind){
		return this.exec(scope, map, bind).toString();
	},

	tag: function(fn, bind){
		return fn.apply(bind, [this.strings].concat(this.result.values));
	}
});

/*
String.format = function(string){
	var tpl = StringTemplate.new(string);

	if( arguments.length > 1 ){
		var scope = Array.prototype.slice.call(arguments, tpl.expressions.length);
		tpl.exec(scope);
	}

	return tpl.toString();
};
*/

module.exports = StringTemplate;
