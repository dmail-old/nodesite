
require('Object.instance');

var Parser = {
	open: '{',
	close: '}',
	string: null,
	tokens: null,
	cache: {},

	new: function(string){
		string = String(string);

		if( string in this.cache ){
			return this.cache[string];
		}
		else{
			return this.cache[string] = Object.prototype.new.call(this, string);
		}
	},

	init: function(string){
		this.string = string;
	},

	// https://github.com/Polymer/TemplateBinding/blob/master/src/TemplateBinding.js
	parse: function(){
		if( this.tokens ) return this.tokens;

		var string = this.string;
		var tokens = [], open = this.open, close = this.close, length = string.length;
		var startIndex = 0, lastIndex = 0, endIndex = 0;

		while( lastIndex < length ){
			startIndex = string.indexOf(open, lastIndex);
			endIndex = startIndex < 0 ? -1 : string.indexOf(close, startIndex + close.length);
			if( endIndex < 0 ){
				tokens.push(string.slice(lastIndex)); // TEXT
				break;
			}

			tokens.push(string.slice(lastIndex, startIndex)); // TEXT
			tokens.push(string.slice(startIndex + open.length, endIndex).trim()); // PATH
			lastIndex = endIndex + close.length;
		}

		if( lastIndex === length ){
			tokens.push(''); // TEXT
		}

		return this.tokens = tokens;
	}
};

var StringTemplate = {
	Parser: Parser,

	init: function(string){
		this.parser = this.Parser.new(string);
	},

	parse: function(){		
		return this.parser.parse();
	},

	empty: function(token){
		return this.parser.open + token + this.parser.close;
	},

	replacer: function(token, data){
		if( token in data ) return data[token];
		return this.empty(token);
	},

	replace: function(tokens, data, replacer, bind){
		if( typeof replacer != 'function' ) throw new TypeError('replacer must be a function');

		var result, token, i, j;

		result = tokens[0];
		i = 0;
		j = tokens.length;
		for(;i<j;i+=2){
			token = tokens[i];
			result+= replacer.call(bind, token, data, i);
			result+= tokens[i + 1];
		}

		return result;
	},

	render: function(data){
		return this.replace(this.parser.parse(), data, this.replacer, this);
	}
};

module.exports = StringTemplate;