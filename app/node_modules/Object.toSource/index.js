/*

https://github.com/oliver-moran/toSource.js

*/


if( 'toSource' in Object === false ){

	var implementToSource = function(constructor, toSource){
		Object.defineProperty(constructor.prototype, 'toSource', {
			writable: true,
			value: toSource
		});
	};

	implementToSource(Number, function(){
		return this.toString();
	});

	implementToSource(Boolean, function(){
		return this.toString();
	});

	implementToSource(RegExp, function(){
		return this.toString();
	});

	implementToSource(Date, function(){
		return '(new Date(' + this.valueOf() + '))';
	});

	implementToSource(String, function(){
		var source = this.replace(/"/g, '"');
		source = source.replace(/\n/g, '\\n');
		source = source.replace(/\r/g, '\\r');
		return '"' + source + '"';
	});

	implementToSource(Function, function(){
		return '(' + this.toString() + ')';
	});

	Object.toSource = function(object, seen){
		if( object === null ) return 'null';
		if( object === undefined ) return 'undefined';
		if( typeof object.toSource === 'function' ) return object.toSource();
		return String(object);
	};

	Object.sourceOf = function(value, seen){
		if( seen && value !== null && typeof value === 'object'){
			if( seen.indexOf(value) > -1 ){
				return '{}';
			}
			seen.push(value);
			return value.toSource(seen);
		}
		return Object.toSource(value);
	};

	implementToSource(Array, function(seen){
		var source, i = 0, j = this.length;

		seen = seen || [this];
		source = '[';
		for(;i<j;i++){
			source+= Object.sourceOf(this[i], seen);
			if( i < j - 1 ) source+= ', ';
		}
		source+= ']';

		return source;
	});

	implementToSource(Object, function(seen){
		var source, props = Object.getOwnPropertyNames(this), i = 0, j = props.length, prop;
		
		seen = seen || [this];
		source = '({';
		for(;i<j;i++){
			prop = props[i];
			source+= prop.toSource() + ': ' + Object.sourceOf(this[prop], seen);
			if( i < j - 1 ) source += ', ';
		}
		source+= '})';

		return source;
	});
	
}

/*

test pour les références circulaires (faut pas les mettre)

var a = {name:'ok', b: {}}; a.b.a = a;
a.toSource();

*/