/*
*/

var proto = require('proto');
var Collector = proto.create({
	Selector: require('../Selector'),
	iterator: null,
	selector: null,
	result: null,
	types: {
		'first': {
			firstBreak: true
		},

		'all': {
			firstBreak: false
		},

		'count': {
			result: 0,
			firstBreak: false,
			encode: function(){
				this.result++;
			}
		},

		// must be called on ArrayIterator only
		'firstIndex': {
			result: -1,
			firstBreak: true,
			encode: function(){
				return this.iterator.index;
			}
		},

		// must be called on ArrayIterator only
		'allIndex': {
			firstBreak: false,
			encode: function(){
				this.result.push(this.iterator.index);
			}
		}	
	},
	type: null,

	init: function(iterator, selector){
		this.iterator = iterator;
		if( arguments.length > 1){
			this.selector = this.createSelector(selector);
		}
	},

	createSelector: function(){
		return this.Selector.new.apply(this.Selector, arguments);
	},

	forOf: function(fn, bind){
		var iterator = this.iterator['@@iterator'](), next;

		next = iterator.next();
		while( next.done === false ){
			if( !fn || fn.call(bind, next.value) === true ) break;
			next = iterator.next();
		}

		return this;
	},

	handleNext: function(value){
		if( this.selector === null || this.selector.match(value) ){
			var result = this.type.encode ? this.type.encode.call(this, value) : value;

			if( this.type.firstBreak ){
				this.result = result;
				return true;
			}
			else{
				this.result.push(result);
			}
		}
	},

	collect: function(typeName){
		this.type = this.types[typeName];
		this.result = 'result' in this.type ? this.type.result : null;
		this.forOf(this.handleNext, this);
		return this.result;
	}
});

Object.key(Collector.types).forEach(function(method){
	Collector[method] = function(){
		return this.collect(method);
	};
});

// speed improvment
Collector.count = function(){
	// my custom iterators have a length property
	if( this.selector == null && typeof this.iterator.length === 'number' ) return this.iterator.length;
	return this.collect('count');
};

module.exports = Collector;